function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{nSQh:function(e,t,n){"use strict";n.r(t);var i,o=n("ofXK"),c=n("3Pt+"),s=n("tyNb"),r=n("CcG0"),a=n("5+WD"),d=n("UN3I"),l=n("OaWH"),b=n("C/ya"),u=n("D/9M"),m=n("g+Po"),f=n("fXoL"),g=n("0IaG"),h=n("BAfr"),p=n("m6yr"),v=n("47y3"),_=function(){return{class:"backoffice-info-with-circle"}},y=function(e){return{id:"about",name:"About",icon:e}},C=function(){return{class:"backoffice-tablet"}},w=function(e,t){return{id:"devices",name:"Devices",count:e,icon:t}},k=function(){return{class:"backoffice-layers"}},O=function(e,t){return{id:"zones",name:"Zones",count:e,icon:t}},x=function(){return{class:"backoffice-stopwatch"}},I=function(e,t){return{id:"triggers",name:"Triggers",count:e,icon:t}},P=function(e,t,n,i){return[e,t,n,i]},V=((i=function(e){function t(e,n,i,o){var c;return _classCallCheck(this,t),(c=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e,n,i)))._service=e,c._route=n,c._router=i,c._dialog=o,c.service=c._service.Systems,c}return _inherits(t,e),_createClass(t,[{key:"loadValues",value:function(){var e=this;this._service.SystemTriggers.query({offset:0,limit:1,sys_id:this.item.id}).then((function(){return e.trigger_count=e._service.SystemTriggers.last_total})),this.device_count=(this.item.modules||[]).length,this.zone_count=(this.item.zones||[]).length}},{key:"new",value:function(){var e=this;this._dialog.open(u.a,{height:"auto",width:"auto",maxHeight:"calc(100vh - 2em)",maxWidth:"calc(100vw - 2em)",data:{item:new d.n(this._service.Systems,{}),service:this._service.Systems}}).componentInstance.event.subscribe((function(t){console.log("Event:",t),"done"===t.reason&&e._router.navigate(["/systems",t.metadata.item.id])}))}},{key:"edit",value:function(){this.item&&this._dialog.open(u.a,{height:"auto",width:"auto",maxHeight:"calc(100vh - 2em)",maxWidth:"calc(100vw - 2em)",data:{item:this.item,service:this._service.Systems}})}},{key:"delete",value:function(){var e=this;if(this.item){var t=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Delete system",content:"<p>Are you sure you want delete this system?</p><p>Deleting this will <strong>immediately</strong> delete modules that are not in another system</p>",icon:{type:"icon",class:"backoffice-trash"}}}));this.subscription("delete_confirm",t.componentInstance.event.subscribe((function(n){"done"===n.reason&&(t.componentInstance.loading="Deleting system...",e.item.delete().then((function(){e._service.notifySuccess('Successfully deleted system "'.concat(e.item.name,'".')),e._router.navigate(["/systems"]),t.close(),e.unsub("delete_confirm")}),(function(n){t.componentInstance.loading=null,e._service.notifyError("Error deleting system. Error: ".concat(n))})))})))}}}]),t}(b.a)).\u0275fac=function(e){return new(e||i)(f.Qb(l.a),f.Qb(s.a),f.Qb(s.c),f.Qb(g.b))},i.\u0275cmp=f.Kb({type:i,selectors:[["app-systems"]],features:[f.zb],decls:5,vars:27,consts:[[1,"container"],[1,"sidebar"],["heading","Systems",3,"module","close","event"],[3,"touchrelease"],["name","system","route","systems",3,"item","loading","tabs","event"]],template:function(e,t){1&e&&(f.Wb(0,"div",0),f.Wb(1,"div",1),f.Wb(2,"sidebar",2),f.ec("event",(function(e){return t.sidebarEvent(e)})),f.Vb(),f.Vb(),f.Wb(3,"main",3),f.ec("touchrelease",(function(e){return t.show_sidebar=!1})),f.Wb(4,"item-display",4),f.ec("event",(function(e){return t.itemEvent(e)})),f.Vb(),f.Vb(),f.Vb()),2&e&&(f.Gb("show",t.show_sidebar),f.Cb(2),f.oc("module",t.module)("close",t.show_sidebar),f.Cb(2),f.oc("item",t.item)("loading",t.loading_item)("tabs",f.tc(22,P,f.qc(8,y,f.pc(7,_)),f.rc(11,w,t.device_count,f.pc(10,C)),f.rc(15,O,t.zone_count,f.pc(14,k)),f.rc(19,I,t.trigger_count,f.pc(18,x)))))},directives:[h.a,p.b,v.a],styles:[".container[_ngcontent-%COMP%]{display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;height:100%;width:100%}@media only screen and (orientation:portrait)and (max-width:450px){.container[_ngcontent-%COMP%]{-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}}@media only screen and (orientation:landscape)and (max-width:800px){.container[_ngcontent-%COMP%]{-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}}@media only screen and (orientation:portrait)and (max-width:450px){.container.show[_ngcontent-%COMP%]   .sidebar[_ngcontent-%COMP%]{height:100%}}@media only screen and (orientation:landscape)and (max-width:800px){.container.show[_ngcontent-%COMP%]   .sidebar[_ngcontent-%COMP%]{height:100%}}@media only screen and (orientation:portrait)and (max-width:450px){.container.show[_ngcontent-%COMP%]   main[_ngcontent-%COMP%]{height:0%}}@media only screen and (orientation:landscape)and (max-width:800px){.container.show[_ngcontent-%COMP%]   main[_ngcontent-%COMP%]{height:0%}}.sidebar[_ngcontent-%COMP%]{height:100%;width:20em}@media only screen and (orientation:portrait)and (max-width:450px){.sidebar[_ngcontent-%COMP%]{height:3em;min-height:3em;width:100%;-webkit-transition:height .3s;transition:height .3s}}@media only screen and (orientation:landscape)and (max-width:800px){.sidebar[_ngcontent-%COMP%]{height:3em;min-height:3em;width:100%;-webkit-transition:height .3s;transition:height .3s}}main[_ngcontent-%COMP%]{position:relative;height:100%;overflow:hidden;-webkit-box-flex:1;flex:1;background-color:#f0f0f0}@media only screen and (orientation:portrait)and (max-width:450px){main[_ngcontent-%COMP%]{-webkit-transition:height .3s;transition:height .3s;width:100%}}@media only screen and (orientation:landscape)and (max-width:800px){main[_ngcontent-%COMP%]{-webkit-transition:height .3s;transition:height .3s;width:100%}}"]}),i),M=n("5f3J"),W=n("YxBP"),z=n("bTqV"),S=n("Mj3r"),j=n("rUqb");function E(e,t){if(1&e&&(f.Wb(0,"div",10),f.Wb(1,"label"),f.Ic(2,"Support URL:"),f.Vb(),f.Wb(3,"div",11),f.Wb(4,"a",12),f.Ic(5),f.Vb(),f.Vb(),f.Vb()),2&e){var n=f.ic(2);f.Cb(4),f.oc("href",n.item.support_url,f.Bc),f.Cb(1),f.Jc(n.item.support_url)}}function A(e,t){if(1&e&&(f.Wb(0,"div",10),f.Wb(1,"label"),f.Ic(2,"Bookable Room:"),f.Vb(),f.Wb(3,"div",11),f.Ic(4),f.Vb(),f.Vb()),2&e){var n=f.ic(2);f.Cb(4),f.Jc(n.item.bookable?"Yes":"No")}}function D(e,t){if(1&e&&(f.Wb(0,"a",12),f.Ic(1),f.Vb()),2&e){var n=f.ic(3);f.oc("href","mailto:"+n.item.email,f.Bc),f.Cb(1),f.Jc(n.item.email)}}function R(e,t){if(1&e&&(f.Wb(0,"div",10),f.Wb(1,"label"),f.Ic(2,"Email:\xa0"),f.Vb(),f.Gc(3,D,2,2,"a",13),f.Vb()),2&e){var n=f.ic(2);f.Cb(3),f.oc("ngIf",n.item.email)}}function T(e,t){if(1&e&&(f.Wb(0,"div",10),f.Wb(1,"label"),f.Ic(2,"Capacity:"),f.Vb(),f.Wb(3,"div",11),f.Ic(4),f.Vb(),f.Vb()),2&e){var n=f.ic(2);f.Cb(4),f.Jc(n.item.capacity)}}function G(e,t){if(1&e&&(f.Wb(0,"div",10),f.Wb(1,"label"),f.Ic(2,"Installed Touch Panels:"),f.Vb(),f.Wb(3,"div",11),f.Ic(4),f.Vb(),f.Vb()),2&e){var n=f.ic(2);f.Cb(4),f.Jc(n.item.installed_ui_devices)}}function F(e,t){1&e&&(f.Wb(0,"header"),f.Ic(1,"Execute command"),f.Vb())}function J(e,t){if(1&e){var n=f.Xb();f.Wb(0,"div",1),f.Wb(1,"section",2),f.Wb(2,"button",3),f.ec("tapped",(function(e){return f.yc(n),f.ic().start()})),f.Ic(3,"Start System"),f.Vb(),f.Wb(4,"button",3),f.ec("tapped",(function(e){return f.yc(n),f.ic().stop()})),f.Ic(5,"Stop System"),f.Vb(),f.Vb(),f.Wb(6,"section",4),f.Gc(7,E,6,2,"div",5),f.Gc(8,A,5,1,"div",5),f.Gc(9,R,4,1,"div",5),f.Gc(10,T,5,1,"div",5),f.Gc(11,G,5,1,"div",5),f.Vb(),f.Gc(12,F,2,0,"header",6),f.Rb(13,"system-exec-field",7),f.Wb(14,"header"),f.Ic(15,"Settings "),f.Wb(16,"span",8),f.ec("touchrelease",(function(e){return f.yc(n),f.ic().toggleSettings()})),f.Ic(17),f.Vb(),f.Vb(),f.Wb(18,"section"),f.Rb(19,"settings-form-field",9),f.Vb(),f.Vb()}if(2&e){var i=f.ic();f.Cb(7),f.oc("ngIf",i.item.support_url),f.Cb(1),f.oc("ngIf",i.item.bookable),f.Cb(1),f.oc("ngIf",i.item.bookable&&i.item.email),f.Cb(1),f.oc("ngIf",i.item.capacity),f.Cb(1),f.oc("ngIf",i.item.installed_ui_devices),f.Cb(1),f.oc("ngIf",i.item&&i.item.id&&i.item.modules),f.Cb(1),f.oc("system",i.item),f.Cb(4),f.Jc(!1===i.merged?"This system":"Merged"),f.Cb(2),f.oc("ngModel",i.settings)("readonly",!0)}}var L,Q=((L=function(e){function t(e,n){var i;return _classCallCheck(this,t),(i=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._service=e,i._dialog=n,i}return _inherits(t,e),_createClass(t,[{key:"modules",value:function(){return _toConsumableArray(this.item.modules)}},{key:"ngOnInit",value:function(){var e=this;this.subscription("item",this._service.listen("BACKOFFICE.active_item",(function(t){e.item=t,e.loadZones()})))}},{key:"ngOnChanges",value:function(e){e.item&&this.item&&this.loadZones()}},{key:"start",value:function(){var e=this,t=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Start system?",content:"Are you sure you want to start this system?<br>All stopped modules within the system will boot up.",icon:{type:"icon",class:"backoffice-controller-play"}}}));this.subscription("confirm_ref",t.componentInstance.event.subscribe((function(t){"done"===t.reason&&e._service.Systems.start(e.item.id).then((function(e){return null}),(function(t){return e._service.notifyError("Failed to start system: ".concat(t.message||t))}))})))}},{key:"stop",value:function(){var e=this,t=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Stop system?",content:"Are you sure you want to stop this system?<br>All modules will be immediately stopped regardless of any other systems they may be in.",icon:{type:"icon",class:"backoffice-controller-stop"}}}));this.subscription("confirm_ref",t.componentInstance.event.subscribe((function(t){"done"===t.reason&&e._service.Systems.stop(e.item.id).then((function(e){return null}),(function(t){return e._service.notifyError("Failed to stop system: ".concat(t.message||t))}))})))}},{key:"toggleSettings",value:function(){this.merged=!1===this.merged,this.updateSettings()}},{key:"updateSettings",value:function(){if(this.item)if(!1!==this.merged){this.settings=Object(W.b)("",this.item.settings.settings_string||"");var e=!0,t=!1,n=void 0;try{for(var i,o=this.zones[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var c=i.value;this.settings=Object(W.b)(this.settings,c.settings.settings_string||"")}}catch(s){t=!0,n=s}finally{try{e||null==o.return||o.return()}finally{if(t)throw n}}}else this.settings=this.item.settings.settings_string||""}},{key:"loadZones",value:function(){var e=this;this.item&&this._service.Zones.query({sys_id:this.item.id,offset:0}).then((function(t){t.sort((function(t,n){return e.item.zones.indexOf(n.id)-e.item.zones.indexOf(t.id)})),e.zones=t,e.updateSettings()}),(function(){return null}))}}]),t}(M.a)).\u0275fac=function(e){return new(e||L)(f.Qb(l.a),f.Qb(g.b))},L.\u0275cmp=f.Kb({type:L,selectors:[["system-about"]],inputs:{item:"item"},features:[f.zb,f.Ab()],decls:1,vars:1,consts:[["class","container",4,"ngIf"],[1,"container"],[1,"select"],["mat-button","",3,"tapped"],[1,"details"],["class","field",4,"ngIf"],[4,"ngIf"],[3,"system"],[3,"touchrelease"],[3,"ngModel","readonly"],[1,"field"],[1,"value"],["target","_blank",3,"href"],["target","_blank",3,"href",4,"ngIf"]],template:function(e,t){1&e&&f.Gc(0,J,20,10,"div",0),2&e&&f.oc("ngIf",t.item)},directives:[o.m,z.b,p.b,S.a,j.a,c.k,c.n],styles:[".container[_ngcontent-%COMP%]{padding:1em}header[_ngcontent-%COMP%]{display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;font-weight:700;font-size:1.1em}header[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:.7em;color:rgba(0,0,0,.6);padding:0 1em;font-weight:300;text-decoration:underline;cursor:pointer;-webkit-transition:color .2s;transition:color .2s}header[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:hover{color:rgba(0,0,0,.85)}section[_ngcontent-%COMP%]{padding:.5em .25em}.select[_ngcontent-%COMP%]{display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;margin-bottom:.25em}button[_ngcontent-%COMP%]{margin:0 .25em}button[_ngcontent-%COMP%]:first-child{margin-left:0}button[_ngcontent-%COMP%]:last-child{margin-right:0}.field[_ngcontent-%COMP%]{display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;margin:.25em 0}.field[_ngcontent-%COMP%]   .value[_ngcontent-%COMP%]{padding:0 .5em}label[_ngcontent-%COMP%]{font-size:.8em;font-weight:500}a[_ngcontent-%COMP%]{font-size:.9em}"]}),L),Z=n("SxV6"),B=n("DuJs"),$=n("GrRB"),N=n("EY9O"),X=n("bSwM"),q=n("STbY"),K=n("0njA"),H=n("v26h");function U(e,t){if(1&e){var n=f.Xb();f.Wb(0,"i",33),f.ec("modelChange",(function(e){return f.yc(n),f.ic().$implicit.connected=e})),f.Vb()}if(2&e){var i=f.ic().$implicit,o=f.ic(3);f.oc("model",i.connected)("sys",o.item.id)("mod",o.device_classes[i.id])}}function Y(e,t){1&e&&f.Rb(0,"i",34)}function ee(e,t){if(1&e){var n=f.Xb();f.Wb(0,"button",35),f.ec("tapped",(function(e){f.yc(n);var i=t.$implicit,o=f.ic().$implicit;return f.ic(3).handleContextEvent(i,o)})),f.Rb(1,"app-icon",29),f.Wb(2,"div",36),f.Ic(3),f.Vb(),f.Vb()}if(2&e){var i=t.$implicit;f.Cb(1),f.oc("icon",i.icon),f.Cb(2),f.Jc(i.name)}}function te(e,t){1&e&&f.Rb(0,"td",37)}var ne=function(e){return["/devices",e]},ie=function(){return{class:"backoffice-dots-three-vertical"}};function oe(e,t){if(1&e){var n=f.Xb();f.Wb(0,"tr",17),f.ec("contextAction",(function(e){f.yc(n);var i=t.$implicit;return f.ic(3).handleContextEvent(e,i)})),f.Wb(1,"td",11),f.Wb(2,"div",18),f.Rb(3,"i",19),f.Vb(),f.Vb(),f.Wb(4,"td",11),f.Gc(5,U,1,3,"i",20),f.Wb(6,"div",21),f.ec("tapped",(function(e){f.yc(n);var i=t.$implicit;return f.ic(3).power(i)})),f.Vb(),f.Vb(),f.Wb(7,"td",12),f.Wb(8,"a",22),f.Ic(9),f.Vb(),f.Vb(),f.Wb(10,"td",13),f.Wb(11,"mat-checkbox",23),f.ec("change",(function(e){f.yc(n);var i=t.$implicit,o=f.ic(3);return o.device_listener[i.id]=e.checked,o.toggleDebugEvents(i)})),f.Ic(12),f.Vb(),f.Vb(),f.Wb(13,"td",14),f.Wb(14,"div",24),f.Gc(15,Y,1,0,"i",25),f.Vb(),f.Wb(16,"a",26),f.Ic(17),f.Vb(),f.Vb(),f.Wb(18,"td",27),f.Wb(19,"button",28),f.Rb(20,"app-icon",29),f.Vb(),f.Wb(21,"mat-menu",null,30),f.Gc(23,ee,4,2,"button",31),f.Vb(),f.Vb(),f.Gc(24,te,1,0,"td",32),f.Vb()}if(2&e){var i=t.$implicit,o=f.vc(22),c=f.ic(3);f.oc("context-menu",o)("offset_y",-64),f.Cb(5),f.oc("ngIf",i&&c.item.id),f.Cb(1),f.Gb("active",i.connected),f.Cb(2),f.oc("routerLink",f.qc(15,ne,i.id)),f.Cb(1),f.Jc(i.name),f.Cb(2),f.oc("checked",c.device_listener[i.id]),f.Cb(1),f.Kc(" ",c.device_classes[i.id]," "),f.Cb(3),f.oc("ngIf",i.tls),f.Cb(1),f.oc("href",(i.tls?"https://":"http://")+i.ip,f.Bc),f.Cb(1),f.Jc(i.ip),f.Cb(2),f.oc("matMenuTriggerFor",o),f.Cb(1),f.oc("icon",f.pc(17,ie)),f.Cb(3),f.oc("ngForOf",c.menu_options)}}var ce=function(){return[]};function se(e,t){if(1&e){var n=f.Xb();f.Wb(0,"table"),f.Wb(1,"thead"),f.Rb(2,"td",11),f.Rb(3,"td",11),f.Wb(4,"td",12),f.Ic(5,"Name"),f.Vb(),f.Wb(6,"td",13),f.Ic(7,"Class"),f.Vb(),f.Wb(8,"td",14),f.Ic(9,"IP"),f.Vb(),f.Rb(10,"td",11),f.Vb(),f.Wb(11,"tbody",15),f.ec("cdkDropListDropped",(function(e){return f.yc(n),f.ic(2).drop(e)})),f.Gc(12,oe,25,18,"tr",16),f.Vb(),f.Vb()}if(2&e){var i=f.ic(2);f.Cb(12),f.oc("ngForOf",i.devices||f.pc(1,ce))}}function re(e,t){1&e&&(f.Wb(0,"div",38),f.Wb(1,"div",36),f.Ic(2,"No devices for system"),f.Vb(),f.Vb())}function ae(e,t){if(1&e&&(f.Wb(0,"section",39),f.Rb(1,"a-terminal",40),f.Vb()),2&e){var n=f.ic(2);f.Cb(1),f.oc("content",n.device_logs)}}function de(e,t){if(1&e){var n=f.Xb();f.Wb(0,"div",1),f.Wb(1,"section",2),f.Wb(2,"button",3),f.ec("tapped",(function(e){return f.yc(n),f.ic().newDevice()})),f.Ic(3,"Add new"),f.Vb(),f.Wb(4,"div",4),f.Wb(5,"item-search-field",5),f.ec("ngModelChange",(function(e){return f.yc(n),f.ic().new_module=e.id})),f.Vb(),f.Vb(),f.Wb(6,"button",6),f.ec("tapped",(function(e){return f.yc(n),f.ic().addDevice()})),f.Ic(7," Add existing "),f.Vb(),f.Vb(),f.Wb(8,"section",7),f.Gc(9,se,13,2,"table",8),f.Gc(10,re,3,0,"div",9),f.Vb(),f.Gc(11,ae,2,1,"section",10),f.Vb()}if(2&e){var i=f.ic();f.Cb(5),f.oc("service",i.module_service)("ngModel",null),f.Cb(1),f.oc("disabled",!i.new_module),f.Cb(3),f.oc("ngIf",i.devices&&i.devices.length>0),f.Cb(1),f.oc("ngIf",!i.devices||i.devices.length<=0),f.Cb(1),f.oc("ngIf",i.is_listening)}}var le,be=((le=function(e){function t(e,n,i){var o;return _classCallCheck(this,t),(o=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._service=e,o._dialog=n,o._composer=i,o.device_classes={},o.device_listener={},o.device_logs="",o.menu_options=[{id:"power",name:"Toggle Power",icon:{type:"icon",class:"backoffice-power-plug"}},{id:"state",name:"View State",icon:{type:"icon",class:"backoffice-eye"}},{id:"reload",name:"Reload Device",icon:{type:"icon",class:"backoffice-cw"}},{id:"remove",name:"Remove Device",icon:{type:"icon",class:"backoffice-trash"}}],o}return _inherits(t,e),_createClass(t,[{key:"ngOnInit",value:function(){var e=this;this.subscription("item",this._service.listen("BACKOFFICE.active_item",(function(t){e.item=t,e.loadDevices()}))),this.device_logs="",this._service.initialised.pipe(Object(Z.a)((function(e){return e}))).subscribe((function(){e.subscription("debug_events",e._composer.realtime.debug_events.subscribe((function(t){e.item.modules.find((function(e){return e===t.module}))&&(e.device_logs+="\n\n"+t.message)})))}))}},{key:"ngOnChanges",value:function(e){e.item&&this.loadDevices()}},{key:"loadDevices",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.item&&this._service.Modules.query({system_id:this.item.id,offset:t}).then((function(t){t.sort((function(t,n){return e.item.modules.indexOf(t.id)-e.item.modules.indexOf(n.id)})),e.devices=t,e.generateDeviceBindings()}),(function(){return null}))}},{key:"handleContextEvent",value:function(e,t){if(e)switch(e.id){case"power":this.power(t);break;case"state":this.viewState(t);break;case"reload":this.reloadModule(t);break;case"remove":this.remove(t)}}},{key:"power",value:function(e){var t=this;e.running?e.stop().then((function(){t._service.notifySuccess("Module successfully stopped"),t.reload(e)}),(function(n){"string"==typeof n&&n.length<64?t._service.notifyError(n):t._service.notifyError("Failed to stop device '".concat(e.id,"'.\nView Error?"),"View",(function(){}))})):e.start().then((function(){t._service.notifySuccess("Module successfully stopped"),t.reload(e)}),(function(n){"string"==typeof n&&n.length<64?t._service.notifyError(n):t._service.notifyError("Failed to stop device '".concat(e.id,"'.\nView Error?"),"View",(function(){}))}))}},{key:"reload",value:function(e){this._service.Modules.show(e.id).then((function(t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}),(function(){return null}))}},{key:"viewState",value:function(e){this._dialog.open(B.a,{data:{system:this.item,module:e,devices:this.devices}})}},{key:"reloadModule",value:function(e){var t=this,n=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Reload module?",content:"New driver code will be loaded and the device settings will be reloaded.",icon:{type:"icon",class:"backoffice-install"}}}));this.subscription("confirm_ref",n.componentInstance.event.subscribe((function(i){"done"===i.reason&&((e.driver?e.driver.reload():t._service.Drivers.reload(e.dependency_id)).then((function(e){return t._service.notifySuccess("Driver successfully reloaded.")}),(function(e){return t._service.notifyError(e.message||e)})),n.close(),t.unsub("confirm_ref"))})))}},{key:"drop",value:function(e){var t=this;if(e&&e.previousIndex!==e.currentIndex){var n=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Change order?",content:"Are you sure you want to change the module priority?<br>Settings will be updated immediately for the system.",icon:{type:"icon",class:"backoffice-layers"}}}));this.subscription("confirm_ref",n.componentInstance.event.subscribe((function(i){if("done"===i.reason){n.componentInstance.loading="Updating device order...";var o=_toConsumableArray(t.item.modules);Object(a.f)(o,e.previousIndex,e.currentIndex),t.item.storePendingChange("modules",o),t.item.save().then((function(){n.close(),t.unsub("confirm_ref")}),(function(e){n.componentInstance.loading=null,t._service.notifyError("Error reording devices. Error: ".concat(e.message||e))}))}})))}}},{key:"remove",value:function(e){var t=this,n=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Remove module?",content:"Remove ".concat(e.dependency_id," from this system?<br>If this is not used elsewhere the associated data will be removed immediately."),icon:{type:"icon",class:"backoffice-trash"}}}));this.subscription("confirm_ref",n.componentInstance.event.subscribe((function(e){"done"===e.reason&&(n.close(),t.unsub("confirm_ref"))})))}},{key:"newDevice",value:function(){var e=this;this._service.Modules.add({control_system:this.item}).then((function(t){e._service.notifySuccess("Created new device"),e.joinDevice(t.id)}),(function(){e._service.notifyError("Error creating new device")}))}},{key:"addDevice",value:function(){this.new_module&&(this.joinDevice(this.new_module),this.new_module="")}},{key:"joinDevice",value:function(e){var t=this,n=_toConsumableArray(this.item.modules);n.indexOf(e)<0&&n.push(e),this.item.storePendingChange("modules",n),this.item.save().then((function(){t._service.notifySuccess("Successfully added device to system"),t.loadDevices()}),(function(){t._service.notifyError("Failed to add module to system")}))}},{key:"toggleDebugEvents",value:function(e){e&&(console.log("Toggle Device:",e,this.device_listener[e.id]),this.device_listener[e.id]?this.subscription("debug_".concat(e.id),e.debug()):this.unsub("debug_".concat(e.id)))}},{key:"generateDeviceBindings",value:function(){var e={},t=!0,n=!1,i=void 0;try{for(var o,c=this.devices[Symbol.iterator]();!(t=(o=c.next()).done);t=!0){var s=o.value,r=s.custom_name||(s.driver?s.driver.module_name:"")||"Blank";e[r]||(e[r]=0),this.device_classes[s.id]="".concat(r,"_").concat(++e[r])}}catch(a){n=!0,i=a}finally{try{t||null==c.return||c.return()}finally{if(n)throw i}}}},{key:"module_service",get:function(){return this._service.Modules}},{key:"is_listening",get:function(){for(var e in this.device_listener)if(this.device_listener.hasOwnProperty(e)&&this.device_listener[e])return!0;return!1}}]),t}(M.a)).\u0275fac=function(e){return new(e||le)(f.Qb(l.a),f.Qb(g.b),f.Qb(r.c))},le.\u0275cmp=f.Kb({type:le,selectors:[["system-devices"]],inputs:{item:"item"},features:[f.zb,f.Ab()],decls:1,vars:1,consts:[["class","container",4,"ngIf"],[1,"container"],[1,"select"],["mat-button","",3,"tapped"],[1,"dropdown"],[3,"service","ngModel","ngModelChange"],["mat-button","",3,"disabled","tapped"],[1,"device-list"],[4,"ngIf"],["class","info-block",4,"ngIf"],["class","terminal",4,"ngIf"],[1,"small"],[1,"name"],[1,"module"],[1,"ip"],["cdkDropList","",3,"cdkDropListDropped"],["cdkDrag","",3,"context-menu","offset_y","contextAction",4,"ngFor","ngForOf"],["cdkDrag","",3,"context-menu","offset_y","contextAction"],["cdkDragHandle","",1,"action","grab"],[1,"backoffice-select-arrows"],["binding","","bind","connected",3,"model","sys","mod","modelChange",4,"ngIf"],[1,"state",3,"tapped"],["routerLinkActive","router-link-active",3,"routerLink"],[3,"checked","change"],[1,"lock"],["class","backoffice-lock",4,"ngIf"],[3,"href"],["touchrelease","",1,"small"],["mat-icon-button","",3,"matMenuTriggerFor"],[3,"icon"],["menu","matMenu"],["mat-menu-item","",3,"tapped",4,"ngFor","ngForOf"],["class","placeholder","colspan","6",4,"cdkDragPlaceholder"],["binding","","bind","connected",3,"model","sys","mod","modelChange"],[1,"backoffice-lock"],["mat-menu-item","",3,"tapped"],[1,"text"],["colspan","6",1,"placeholder"],[1,"info-block"],[1,"terminal"],[3,"content"]],template:function(e,t){1&e&&f.Gc(0,de,12,6,"div",0),2&e&&f.oc("ngIf",t.item)},directives:[o.m,z.b,p.b,$.a,c.k,c.n,a.d,o.l,a.a,N.a,a.b,s.f,s.e,X.a,q.c,K.a,q.d,a.c,r.a,q.a,H.a],styles:[".container[_ngcontent-%COMP%]{position:absolute;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;top:4em;left:0;right:0;bottom:0;overflow:hidden}.container[_ngcontent-%COMP%], .options[_ngcontent-%COMP%]{display:-webkit-box;display:flex}.options[_ngcontent-%COMP%]{font-size:1.2em;max-width:5em;margin:0}.table-row[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{-webkit-box-flex:1;flex:1;width:5em}.table-row[_ngcontent-%COMP%]   .module[_ngcontent-%COMP%]{width:10em;min-width:7em}.placeholder[_ngcontent-%COMP%]{background:#ccc;border:3px dotted #999;min-height:3em;-webkit-transition:-webkit-transform .25s cubic-bezier(0,0,.2,1);transition:-webkit-transform .25s cubic-bezier(0,0,.2,1);transition:transform .25s cubic-bezier(0,0,.2,1);transition:transform .25s cubic-bezier(0,0,.2,1),-webkit-transform .25s cubic-bezier(0,0,.2,1)}.device-list[_ngcontent-%COMP%]{-webkit-box-flex:1;flex:1;min-height:8em;overflow:auto;padding:1em}.lock[_ngcontent-%COMP%]{height:1.2em;width:1.2em;display:-webkit-inline-box;display:inline-flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center}.state[_ngcontent-%COMP%]{height:16px;width:16px;margin:.25em;background-color:#000;border-radius:.8em;-webkit-transition:margin .25s,height .25s,width .25s,background-color .3s;transition:margin .25s,height .25s,width .25s,background-color .3s}.state.active[_ngcontent-%COMP%]{background-color:#4caf50;height:8px;width:8px;margin:8px}.terminal[_ngcontent-%COMP%]{padding-top:.5em}.select[_ngcontent-%COMP%]{display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;padding:1em 1em 0}.select[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin:0 .25em 1.5em}.select[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:first-child{margin-left:0}.select[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:last-child{margin-right:0}.grab[_ngcontent-%COMP%]{cursor:-webkit-grab;cursor:grab}.placeholder[_ngcontent-%COMP%]{background-color:rgba(0,0,0,.1);border:4px dashed rgba(0,0,0,.6);height:2em}a[_ngcontent-%COMP%]{color:rgba(0,0,0,.85)}.mat-menu-item[_ngcontent-%COMP%]{display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;padding:0 1em}.mat-menu-item[_ngcontent-%COMP%]   app-icon[_ngcontent-%COMP%]{font-size:1.2em}.mat-menu-item[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{-webkit-box-flex:1;flex:1;min-width:50%;margin-left:.5em}"]}),le),ue=n("uxQG"),me=n("kmnG"),fe=n("qFsG"),ge=n("oIn+"),he=function(e){return["/triggers",e]},pe=function(){return{class:"backoffice-edit"}},ve=function(){return{class:"backoffice-trash"}};function _e(e,t){if(1&e){var n=f.Xb();f.Wb(0,"tr"),f.Wb(1,"td",13),f.Rb(2,"div",19),f.Vb(),f.Wb(3,"td",14),f.Wb(4,"a",20),f.Ic(5),f.Vb(),f.Vb(),f.Wb(6,"td",15),f.Ic(7),f.Vb(),f.Wb(8,"td",16),f.Ic(9),f.jc(10,"dateFrom"),f.Vb(),f.Wb(11,"td",17),f.Wb(12,"div",21),f.Wb(13,"button",22),f.ec("tapped",(function(e){f.yc(n);var i=t.$implicit;return f.ic(3).editTrigger(i)})),f.Rb(14,"app-icon",9),f.Vb(),f.Wb(15,"button",22),f.ec("tapped",(function(e){f.yc(n);var i=t.$implicit;return f.ic(3).deleteTrigger(i)})),f.Rb(16,"app-icon",9),f.Vb(),f.Vb(),f.Vb(),f.Vb()}if(2&e){var i=t.$implicit;f.Cb(2),f.Gb("active",i.enabled),f.Cb(2),f.oc("routerLink",f.qc(10,he,i.id)),f.Cb(1),f.Jc(i.name),f.Cb(2),f.Jc(i.activated_count||"0"),f.Cb(2),f.Jc(f.kc(10,8,1e3*(i.created_at-0))),f.Cb(5),f.oc("icon",f.pc(12,pe)),f.Cb(2),f.oc("icon",f.pc(13,ve))}}function ye(e,t){if(1&e&&(f.Wb(0,"table"),f.Wb(1,"thead"),f.Rb(2,"td",13),f.Wb(3,"td",14),f.Ic(4,"Name"),f.Vb(),f.Wb(5,"td",15),f.Ic(6,"Count"),f.Vb(),f.Wb(7,"td",16),f.Ic(8,"Added"),f.Vb(),f.Rb(9,"td",17),f.Vb(),f.Wb(10,"tbody"),f.Gc(11,_e,17,14,"tr",18),f.Vb(),f.Vb()),2&e){var n=f.ic(2);f.Cb(11),f.oc("ngForOf",n.trigger_list)}}var Ce=function(){return{class:"backoffice-magnifying-glass"}};function we(e,t){if(1&e){var n=f.Xb();f.Wb(0,"div",2),f.Wb(1,"div",3),f.Wb(2,"section",4),f.Wb(3,"div",5),f.Wb(4,"button",6),f.ec("tapped",(function(e){return f.yc(n),f.ic().selectTriggerToAdd()})),f.Ic(5,"Add trigger"),f.Vb(),f.Vb(),f.Wb(6,"mat-form-field",7),f.Wb(7,"div",8),f.Rb(8,"app-icon",9),f.Vb(),f.Wb(9,"input",10),f.ec("ngModelChange",(function(e){return f.yc(n),f.ic().search_str=e})),f.Vb(),f.Vb(),f.Vb(),f.Wb(10,"section",11),f.Gc(11,ye,12,1,"table",12),f.Vb(),f.Vb(),f.Vb()}if(2&e){var i=f.ic(),o=f.vc(2);f.Cb(8),f.oc("icon",f.pc(4,Ce)),f.Cb(1),f.oc("ngModel",i.search_str),f.Cb(2),f.oc("ngIf",i.trigger_list.length>0)("ngIfElse",o)}}function ke(e,t){1&e&&(f.Wb(0,"div",23),f.Wb(1,"div",24),f.Ic(2,"No triggers for system"),f.Vb(),f.Vb())}function Oe(e,t){1&e&&f.Rb(0,"td",9)}function xe(e,t){if(1&e){var n=f.Xb();f.Wb(0,"td",9),f.Wb(1,"button",20),f.ec("tapped",(function(e){f.yc(n);var t=f.ic().$implicit;return f.ic(3).removeZone(t)})),f.Rb(2,"i",21),f.Vb(),f.Vb()}}function Ie(e,t){1&e&&f.Rb(0,"td",22)}var Pe=function(e){return["/zones",e]};function Ve(e,t){if(1&e&&(f.Wb(0,"tr",15),f.Wb(1,"td",9),f.Wb(2,"div",16),f.Rb(3,"i",17),f.Vb(),f.Vb(),f.Wb(4,"td",10),f.Wb(5,"a",18),f.Ic(6),f.Vb(),f.Vb(),f.Wb(7,"td",11),f.Ic(8),f.Vb(),f.Gc(9,xe,3,0,"td",12),f.Gc(10,Ie,1,0,"td",19),f.Vb()),2&e){var n=t.$implicit,i=f.ic(3);f.Cb(5),f.oc("routerLink",f.qc(4,Pe,n.id)),f.Cb(1),f.Jc(n.name),f.Cb(2),f.Jc(n.description),f.Cb(1),f.oc("ngIf",i.zones.length>1)}}function Me(e,t){if(1&e){var n=f.Xb();f.Wb(0,"table"),f.Wb(1,"thead"),f.Rb(2,"td",9),f.Wb(3,"td",10),f.Ic(4,"Name"),f.Vb(),f.Wb(5,"td",11),f.Ic(6,"Description"),f.Vb(),f.Gc(7,Oe,1,0,"td",12),f.Vb(),f.Wb(8,"tbody",13),f.ec("cdkDropListDropped",(function(e){return f.yc(n),f.ic(2).drop(e)})),f.Gc(9,Ve,11,6,"tr",14),f.Vb(),f.Vb()}if(2&e){var i=f.ic(2);f.Cb(7),f.oc("ngIf",i.zones.length>1),f.Cb(2),f.oc("ngForOf",i.zones)}}function We(e,t){1&e&&(f.Wb(0,"div",23),f.Wb(1,"div",24),f.Ic(2,"No zones for system"),f.Vb(),f.Vb())}function ze(e,t){if(1&e){var n=f.Xb();f.Wb(0,"div",1),f.Wb(1,"div",2),f.Wb(2,"section",3),f.Wb(3,"div",4),f.Wb(4,"item-search-field",5),f.ec("ngModelChange",(function(e){return f.yc(n),f.ic().new_zone=e.id})),f.Vb(),f.Vb(),f.Wb(5,"button",6),f.ec("tapped",(function(e){return f.yc(n),f.ic().joinZone()})),f.Ic(6,"Join zone"),f.Vb(),f.Vb(),f.Wb(7,"section"),f.Gc(8,Me,10,2,"table",7),f.Gc(9,We,3,0,"div",8),f.Vb(),f.Vb(),f.Vb()}if(2&e){var i=f.ic();f.Cb(4),f.oc("service",i.zone_service)("ngModel",null),f.Cb(1),f.oc("disabled",!i.new_zone),f.Cb(3),f.oc("ngIf",i.zones&&i.zones.length>0),f.Cb(1),f.oc("ngIf",!i.zones||i.zones.length<=0)}}var Se,je,Ee=[{path:"",component:V,children:[]},{path:":id",component:V,children:[{path:"about",component:Q},{path:"devices",component:be},{path:"triggers",component:(je=function(e){function t(e,n,i){var o;return _classCallCheck(this,t),(o=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._service=e,o._dialog=n,o._composer=i,o.trigger_list=[],o}return _inherits(t,e),_createClass(t,[{key:"ngOnInit",value:function(){var e=this;this.subscription("item",this._service.listen("BACKOFFICE.active_item",(function(t){e.item=t,e.loadSystemTriggers()})))}},{key:"ngOnChanges",value:function(e){e.item&&this.loadSystemTriggers()}},{key:"loadSystemTriggers",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.item&&this._service.SystemTriggers.query({sys_id:this.item.id,offset:t}).then((function(t){e.trigger_list=t}),(function(){return null}))}},{key:"editTrigger",value:function(e){var t=this;if(this.item&&e){var n=this._dialog.open(u.a,{height:"auto",width:"auto",maxHeight:"calc(100vh - 2em)",maxWidth:"calc(100vw - 2em)",data:{item:e,service:this._service.SystemTriggers,external_save:!0}});this.subscription("delete_confirm",n.componentInstance.event.subscribe((function(i){"action"===i.reason&&(n.componentInstance.loading="Saving trigger settings...",t._composer.http.put("".concat(t._composer.auth.api_endpoint,"/systems/").concat(t.item.id,"/triggers/").concat(e.id),e.toJSON(!0)).subscribe((function(){return null}),(function(e){n.componentInstance.loading=null,t._service.notifyError("Error updating trigger settings. Error: ".concat(e.message||e))}),(function(){t._service.notifySuccess("Successfully updated trigger settings."),n.close(),t.unsub("delete_confirm")})))})))}}},{key:"deleteTrigger",value:function(e){var t=this;if(this.item&&e){var n=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Remove trigger",content:'<p>Are you sure you want remove trigger "'.concat(e.name,'"?</p><p>Configuration will be updated <strong>immediately</strong>.</p>'),icon:{type:"icon",class:"backoffice-trash"}}}));this.subscription("delete_confirm",n.componentInstance.event.subscribe((function(i){"done"===i.reason&&(n.componentInstance.loading="Removing trigger...",t._composer.http.delete("".concat(t._composer.auth.api_endpoint,"/systems/").concat(t.item.id,"/triggers/").concat(e.id)).subscribe((function(){return null}),(function(e){n.componentInstance.loading=null,t._service.notifyError("Error removing trigger. Error: ".concat(e.message||e))}),(function(){t._service.notifySuccess('Successfully deleted trigger "'.concat(t.item.name,'".')),n.close(),t.unsub("delete_confirm")})))})))}}},{key:"selectTriggerToAdd",value:function(){var e=this,t=this._dialog.open(ue.a,{height:"auto",width:"auto",data:{service_name:"Triggers"}});this.subscription("dialog_events",t.componentInstance.event.subscribe((function(n){var i=t.componentInstance.item;"action"===n.reason&&i&&(e.addTrigger(i),t.close())}))),t.afterClosed().subscribe((function(){return e.unsub("dialog_events")}))}},{key:"addTrigger",value:function(e){this._service.Systems.task(this.item.id,"triggers",{control_system_id:this.item.id,enabled:!0,important:!1,trigger_id:e.id})}}]),t}(M.a),je.\u0275fac=function(e){return new(e||je)(f.Qb(l.a),f.Qb(g.b),f.Qb(r.c))},je.\u0275cmp=f.Kb({type:je,selectors:[["system-triggers"]],inputs:{item:"item"},features:[f.zb,f.Ab()],decls:3,vars:1,consts:[["class","container",4,"ngIf"],["empty_state",""],[1,"container"],[1,"settings"],[1,"select"],[1,"dropdown"],["mat-button","",3,"tapped"],["appearance","outline"],["matPrefix","",1,"prefix"],[3,"icon"],["matInput","","name","search-filter","placeholder","Filter Triggers",3,"ngModel","ngModelChange"],[1,"list"],[4,"ngIf","ngIfElse"],[1,"small"],[1,"flex"],[1,"count"],[1,"added"],[1,"duo"],[4,"ngFor","ngForOf"],[1,"state"],[3,"routerLink"],[1,"actions"],["mat-icon-button","",3,"tapped"],[1,"info-block"],[1,"text"]],template:function(e,t){1&e&&(f.Gc(0,we,12,5,"div",0),f.Gc(1,ke,3,0,"ng-template",null,1,f.Hc)),2&e&&f.oc("ngIf",t.item)},directives:[o.m,z.b,p.b,me.b,me.e,K.a,fe.a,c.b,c.k,c.n,o.l,s.f],pipes:[ge.a],styles:[".container[_ngcontent-%COMP%]{padding:1em}.list[_ngcontent-%COMP%]{margin-top:.5em}.table-row[_ngcontent-%COMP%]   .added[_ngcontent-%COMP%], .table-row[_ngcontent-%COMP%]   .count[_ngcontent-%COMP%]{width:8em;min-width:8em}.action[_ngcontent-%COMP%]{height:1.5em;width:1.5em;min-width:1.5em;border-radius:.65em;display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center;font-size:1.3em}.action[_ngcontent-%COMP%]:hover{background-color:rgba(0,0,0,.1)}.state[_ngcontent-%COMP%]{height:16px;width:16px;margin:.25em;background-color:#000;border-radius:.8em;-webkit-transition:margin .25s,height .25s,width .25s,background-color .3s;transition:margin .25s,height .25s,width .25s,background-color .3s}.state.active[_ngcontent-%COMP%]{background-color:#4caf50;height:8px;width:8px;margin:.625em}.select[_ngcontent-%COMP%]{display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center}.select[_ngcontent-%COMP%]   mat-form-field[_ngcontent-%COMP%]{-webkit-box-flex:1;flex:1;min-width:50%}.select[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin:0 .25em 1.5em}.select[_ngcontent-%COMP%]   app-icon[_ngcontent-%COMP%]{font-size:1.25em}.duo[_ngcontent-%COMP%]{width:6em}.actions[_ngcontent-%COMP%]{display:-webkit-box;display:flex}"]}),je)},{path:"zones",component:(Se=function(e){function t(e,n){var i;return _classCallCheck(this,t),(i=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._service=e,i._dialog=n,i.loading=new f.n,i}return _inherits(t,e),_createClass(t,[{key:"ngOnInit",value:function(){var e=this;this.subscription("item",this._service.listen("BACKOFFICE.active_item",(function(t){e.item=t,e.loadZones()})))}},{key:"ngOnChanges",value:function(e){e.item&&this.loadZones()}},{key:"loadZones",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.item&&this._service.Zones.query({sys_id:this.item.id,offset:t}).then((function(t){t.sort((function(t,n){return e.item.zones.indexOf(t.id)-e.item.zones.indexOf(n.id)})),e.zones=t}),(function(){return null}))}},{key:"drop",value:function(e){var t=this;if(e&&e.previousIndex!==e.currentIndex){var n=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Change order?",content:"Are you sure you want to change the zone priority?<br>Settings will be updated immediately for the system.",icon:{type:"icon",class:"backoffice-cycle"}}}));this.subscription("confirm_ref",n.componentInstance.event.subscribe((function(i){if("done"===i.reason){var o=_toConsumableArray(t.item.zones);Object(a.f)(o,e.previousIndex,e.currentIndex),n.componentInstance.loading="Updating zone ordering...",t.item.storePendingChange("zones",o),t.item.save().then((function(){n.close(),t.unsub("confirm_ref")}),(function(e){n.componentInstance.loading=null,t._service.notifyError("Error reording zones. Error: ".concat(e.message||e))}))}})))}}},{key:"removeZone",value:function(e){var t=this;if(e&&e.id){var n=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Remove zone?",content:'<p>Are you sure you want remove zone "'.concat(e.name,'" from the system?</p>Configuration will be updated immediately.'),icon:{type:"icon",class:"backoffice-export"}}}));this.subscription("confirm_ref",n.componentInstance.event.subscribe((function(i){"done"===i.reason&&(t.loading.emit(!0),t.item.removeZone(e.id).then((function(e){t.loading.emit(!1),t.item=e,t._service.notifySuccess('Remove zone "'.concat(t.new_zone,'" from system')),n.close(),t.unsub("confirm_ref")}),(function(e){t.loading.emit(!1),t._service.notifySuccess('Error removing "'.concat(t.new_zone,'" from system. Error: ').concat(e)),n.close(),t.unsub("confirm_ref")})))})))}}},{key:"joinZone",value:function(){var e=this;if(this.new_zone)if(this.item.zones.indexOf(this.new_zone)<0){var t=[].concat(_toConsumableArray(this.item.zones),[this.new_zone]).filter((function(e){return!!e}));this.loading.emit(!0);var n=this._dialog.open(m.b,Object.assign(Object.assign({},m.a),{data:{title:"Add zone",content:'Add zone "'.concat(this.new_zone,'" to system "').concat(this.item.name,'"'),icon:{type:"icon",class:"backoffice-upload-to-cloud"}}}));this.subscription("confirm_ref",n.componentInstance.event.subscribe((function(i){"done"===i.reason?(n.componentInstance.loading="Adding zone to system...",e._service.Systems.update(e.item.id,Object.assign(Object.assign({},e.item),{zones:t})).then((function(t){e.new_zone=null,e.loading.emit(!1),e._service.notifySuccess('Added zone "'.concat(e.new_zone,'" to system')),e.item=t,e.loadZones(),n.close(),e.unsub("confirm_ref")}),(function(){n.componentInstance.loading=null,e.loading.emit(!1),e._service.notifyError('Error adding zone "'.concat(e.new_zone,'"'))}))):e.loading.emit(!1)})))}else this._service.notifyInfo("The selected zone is already linked to this system")}},{key:"zone_service",get:function(){return this._service.Zones}}]),t}(M.a),Se.\u0275fac=function(e){return new(e||Se)(f.Qb(l.a),f.Qb(g.b))},Se.\u0275cmp=f.Kb({type:Se,selectors:[["system-zones"]],inputs:{item:"item"},outputs:{loading:"loading"},features:[f.zb,f.Ab()],decls:1,vars:1,consts:[["class","container",4,"ngIf"],[1,"container"],[1,"settings"],[1,"select"],[1,"dropdown"],[3,"service","ngModel","ngModelChange"],["mat-button","",3,"disabled","tapped"],[4,"ngIf"],["class","info-block",4,"ngIf"],[1,"small"],[1,"name"],[1,"description"],["class","small",4,"ngIf"],["cdkDropList","",3,"cdkDropListDropped"],["cdkDrag","",4,"ngFor","ngForOf"],["cdkDrag",""],["cdkDragHandle","",1,"action","grab"],[1,"backoffice-select-arrows"],["routerLinkActive","router-link-active",3,"routerLink"],["class","placeholder","colspan","6",4,"cdkDragPlaceholder"],["mat-icon-button","",3,"tapped"],[1,"backoffice-publish"],["colspan","6",1,"placeholder"],[1,"info-block"],[1,"text"]],template:function(e,t){1&e&&f.Gc(0,ze,10,5,"div",0),2&e&&f.oc("ngIf",t.item)},directives:[o.m,$.a,c.k,c.n,z.b,p.b,a.d,o.l,a.a,a.b,s.f,s.e,a.c],styles:[".container[_ngcontent-%COMP%]{padding:1em}header[_ngcontent-%COMP%]{font-weight:700;font-size:1.1em}section[_ngcontent-%COMP%]{padding:.5em .25em}.select[_ngcontent-%COMP%]{display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center}.select[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin:0 .25em 1.5em}.placeholder[_ngcontent-%COMP%]{background:#ccc;border:3px dotted #999;min-height:3em;height:3em;-webkit-transition:-webkit-transform .25s cubic-bezier(0,0,.2,1);transition:-webkit-transform .25s cubic-bezier(0,0,.2,1);transition:transform .25s cubic-bezier(0,0,.2,1);transition:transform .25s cubic-bezier(0,0,.2,1),-webkit-transform .25s cubic-bezier(0,0,.2,1)}.name[_ngcontent-%COMP%]{min-width:10em}.description[_ngcontent-%COMP%]{font-size:.8em;padding:.5em}"]}),Se)},{path:"**",redirectTo:"about"}]},{path:"**",redirectTo:""}],Ae=n("PCNd");n.d(t,"AppSystemsModule",(function(){return Re}));var De,Re=((De=function e(){_classCallCheck(this,e)}).\u0275mod=f.Ob({type:De}),De.\u0275inj=f.Nb({factory:function(e){return new(e||De)},imports:[[o.c,c.g,r.b,s.g.forChild(Ee),Ae.a,a.e]]}),De)}}]);